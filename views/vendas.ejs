<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Vendas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <style>
        .autocomplete-suggestions {
            position: absolute;
            z-index: 1000;
            background: white;
            border: 1px solid #ccc;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            list-style: none;
            padding: 0;
            margin: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .autocomplete-suggestions li {
            padding: 8px;
            cursor: pointer;
        }
        .autocomplete-suggestions li:hover {
            background-color: #f0f0f0;
        }
        .barcode-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0,123,255,0.5);
        }
    </style>
    <script>
        $(document).ready(function() {
            $('.cpf-mask').mask('000.000.000-00');

            // Busca dinâmica de clientes
            $('#cliente-search').on('input', function() {
                const query = $(this).val();
                if (query.length < 2) {
                    $('#cliente-suggestions').empty().hide();
                    return;
                }
                $.ajax({
                    url: '/clientes/buscar',
                    method: 'GET',
                    data: { search: query },
                    success: function(data) {
                        const suggestions = $('#cliente-suggestions');
                        suggestions.empty();
                        if (data.length === 0) {
                            suggestions.hide();
                            return;
                        }
                        data.forEach(cliente => {
                            suggestions.append(
                                `<li data-id="${cliente.id}" data-nome="${cliente.nome}" data-cpf="${cliente.cpf}">${cliente.nome} (${cliente.cpf})</li>`
                            );
                        });
                        suggestions.show();
                    },
                    error: function(xhr) {
                        $('#error-alert').text('Erro ao buscar clientes: ' + xhr.responseJSON.error).show();
                    }
                });
            });

            // Selecionar cliente ao clicar na sugestão
            $(document).on('click', '#cliente-suggestions li', function() {
                const id = $(this).data('id');
                const nome = $(this).data('nome');
                const cpf = $(this).data('cpf');
                $('#cliente-search').val(`${nome} (${cpf})`);
                $('#id_cliente').val(id);
                $('#cliente-suggestions').empty().hide();
            });

            // Adicionar item à tabela via AJAX
            function adicionarItem(barcode, callback) {
                $.ajax({
                    url: '/produtos/buscar',
                    method: 'GET',
                    data: { barcode: barcode },
                    success: function(data) {
                        const table = $('#itens-venda-table tbody');
                        const index = table.children().length;
                        const subtotal = (data.preco * 1).toFixed(2);
                        table.append(`
                            <tr data-barcode="${data.barcode}">
                                <td>${data.nome}</td>
                                <td>${data.barcode}</td>
                                <td>R$ ${parseFloat(data.preco).toFixed(2)}</td>
                                <td><input type="number" class="form-control quantidade-input" name="itens[${index}][quantidade]" value="1" min="1" max="${data.estoque}" required></td>
                                <td class="subtotal">R$ ${subtotal}</td>
                                <td>
                                    <input type="hidden" name="itens[${index}][barcode]" value="${data.barcode}">
                                    <button type="button" class="btn btn-danger btn-sm remove-item">Remover</button>
                                </td>
                            </tr>
                        `);
                        updateTotal();
                        callback();
                    },
                    error: function(xhr) {
                        $('#error-alert').text('Erro: ' + xhr.responseJSON.error).show();
                    }
                });
            }

            // Atualizar subtotal e total geral
            function updateTotal() {
                let total = 0;
                $('#itens-venda-table tbody tr').each(function() {
                    const preco = parseFloat($(this).find('td:eq(2)').text().replace('R$ ', ''));
                    const quantidade = parseInt($(this).find('.quantidade-input').val()) || 0;
                    const subtotal = preco * quantidade;
                    $(this).find('.subtotal').text(`R$ ${subtotal.toFixed(2)}`);
                    total += subtotal;
                });
                $('#total-venda').text(`Total: R$ ${total.toFixed(2)}`);
            }

            // Evento para bipar código de barras
            $('#barcode-input').on('keypress', function(e) {
                if (e.which === 13) { // Enter
                    e.preventDefault();
                    const barcode = $(this).val().trim();
                    if (!barcode) return;
                    $('#error-alert').hide();
                    adicionarItem(barcode, () => {
                        $(this).val('').focus();
                    });
                }
            });

            // Atualizar subtotal ao mudar quantidade
            $(document).on('input', '.quantidade-input', updateTotal);

            // Remover item
            $(document).on('click', '.remove-item', function() {
                $(this).closest('tr').remove();
                updateTotal();
            });

            // Preencher itens do formData (em caso de erro)
            <% if (formData.itens && Array.isArray(formData.itens)) { %>
                <% formData.itens.forEach(item => { %>
                    $.ajax({
                        url: '/produtos/buscar',
                        method: 'GET',
                        data: { barcode: '<%= item.barcode ? item.barcode.replace(/'/g, "\\'").replace(/"/g, '&quot;') : '' %>' },
                        success: function(data) {
                            const table = $('#itens-venda-table tbody');
                            const index = table.children().length;
                            const quantidade = <%= item.quantidade || 1 %>;
                            const subtotal = (data.preco * quantidade).toFixed(2);
                            table.append(`
                                <tr data-barcode="${data.barcode}">
                                    <td>${data.nome}</td>
                                    <td>${data.barcode}</td>
                                    <td>R$ ${parseFloat(data.preco).toFixed(2)}</td>
                                    <td><input type="number" class="form-control quantidade-input" name="itens[${index}][quantidade]" value="${quantidade}" min="1" max="${data.estoque}" required></td>
                                    <td class="subtotal">R$ ${subtotal}</td>
                                    <td>
                                        <input type="hidden" name="itens[${index}][barcode]" value="${data.barcode}">
                                        <button type="button" class="btn btn-danger btn-sm remove-item">Remover</button>
                                    </td>
                                </tr>
                            `);
                            updateTotal();
                        },
                        error: function(xhr) {
                            $('#error-alert').text('Erro: ' + xhr.responseJSON.error).show();
                        }
                    });
                <% }); %>
            <% } %>

            // Cadastrar novo cliente via AJAX
            $('#form-novo-cliente').submit(function(e) {
                e.preventDefault();
                $('#cliente-error').hide();
                const formData = $(this).serialize();
                $.ajax({
                    url: '/clientes/novo',
                    method: 'POST',
                    data: formData,
                    success: function(data) {
                        $('#cliente-search').val(`${data.nome} (${data.cpf})`);
                        $('#id_cliente').val(data.id);
                        $('#novoClienteModal').modal('hide');
                        $('#form-novo-cliente')[0].reset();
                    },
                    error: function(xhr) {
                        $('#cliente-error').text('Erro: ' + xhr.responseJSON.error).show();
                    }
                });
            });

            // Limpar modal ao fechar
            $('#novoClienteModal').on('hidden.bs.modal', function() {
                $('#form-novo-cliente')[0].reset();
                $('#cliente-error').hide();
            });
        });
    </script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Gerenciador</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/produtos">Produtos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/clientes">Clientes</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/vendas">Vendas</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/carga-produtos">Carga de Produtos</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container mt-4">
        <h1 class="mb-4">Gerenciar Vendas</h1>
        <% if (error) { %>
            <div class="alert alert-danger alert-dismissible fade show" id="error-alert" role="alert">
                <%= error %>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        <% } %>
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Registrar Venda</h5>
                <form id="venda-form" action="/vendas" method="POST">
                    <div class="mb-3">
                        <label class="form-label">Cliente</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="cliente-search" placeholder="Buscar por nome, email ou CPF" value="<%= formData.cliente_nome || '' %>">
                            <input type="hidden" name="id_cliente" id="id_cliente" value="<%= formData.id_cliente || '' %>">
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#novoClienteModal">Novo Cliente</button>
                        </div>
                        <ul id="cliente-suggestions" class="autocomplete-suggestions" style="display: none;"></ul>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Código de Barras</label>
                        <input type="text" class="form-control barcode-input" id="barcode-input" placeholder="Bipar ou digitar código de barras">
                    </div>
                    <h6>Itens da Venda</h6>
                    <div class="table-responsive mb-3">
                        <table class="table table-striped table-hover" id="itens-venda-table">
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Código de Barras</th>
                                    <th>Valor Unitário</th>
                                    <th>Quantidade</th>
                                    <th>Subtotal</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                    <div class="mb-3">
                        <strong id="total-venda">Total: R$ 0.00</strong>
                    </div>
                    <button type="submit" class="btn btn-primary" id="fechar-venda">Fechar Venda</button>
                </form>
            </div>
        </div>
        <!-- Modal para Novo Cliente -->
        <div class="modal fade" id="novoClienteModal" tabindex="-1" aria-labelledby="novoClienteModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="novoClienteModalLabel">Cadastrar Novo Cliente</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-danger alert-dismissible fade show" id="cliente-error" style="display: none;">
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        <form id="form-novo-cliente">
                            <div class="mb-3">
                                <label class="form-label">Nome *</label>
                                <input type="text" class="form-control" name="nome" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">CPF (000.000.000-00) *</label>
                                <input type="text" class="form-control cpf-mask" name="cpf" placeholder="000.000.000-00" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" name="email">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Telefone</label>
                                <input type="text" class="form-control" name="telefone">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Endereço</label>
                                <textarea class="form-control" name="endereco"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Cadastrar Cliente</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <h2 class="mb-3">Lista de Vendas</h2>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Cliente</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    <% vendas.forEach(venda => { %>
                        <tr>
                            <td><%= venda.data_venda.toLocaleString('pt-BR') %></td>
                            <td><%= venda.cliente_nome || 'Sem cliente' %></td>
                            <td>R$ <%= parseFloat(venda.total).toFixed(2) %></td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>